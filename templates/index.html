<!DOCTYPE html>
<html>
<head>
    <title>Financial Analyzer</title>
    <meta charset="UTF-8">
    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f0f0f0;
            --bg-button: #f0f0f0;
            --bg-button-hover: #e0e0e0;
            --text-primary: #000000;
            --text-secondary: #333333;
            --border-color: #ccc;
            --active-color: #007bff;
            --active-border: #0056b3;
            --shadow-color: rgba(0,0,0,0.1);
            --checkbox-bg: #ffffff;
        }

        [data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-button: #3d3d3d;
            --bg-button-hover: #4d4d4d;
            --text-primary: #ffffff;
            --text-secondary: #e0e0e0;
            --border-color: #666;
            --active-color: #0056b3;
            --active-border: #004099;
            --shadow-color: rgba(255,255,255,0.1);
            --checkbox-bg: #3d3d3d;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }

        h1 {
            color: var(--text-primary);
        }

        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            background-color: var(--bg-button);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            cursor: pointer;
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.3s;
            z-index: 1000;
        }

        .theme-toggle:hover {
            background-color: var(--bg-button-hover);
        }

        .companies-section {
            margin-bottom: 30px;
            padding: 20px;
            background-color: var(--bg-secondary);
            border-radius: 8px;
            box-shadow: 0 2px 10px var(--shadow-color);
        }

        .companies-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .companies-header h2 {
            margin: 0;
            font-size: 1.2em;
            color: var(--text-primary);
        }

        .company-controls {
            display: flex;
            gap: 10px;
        }

        .company-control-btn {
            padding: 5px 15px;
            background-color: var(--bg-button);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            cursor: pointer;
            color: var(--text-primary);
            font-size: 12px;
            transition: all 0.3s;
        }

        .company-control-btn:hover {
            background-color: var(--bg-button-hover);
        }

        .category-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .category-tab {
            padding: 8px 16px;
            background-color: var(--bg-button);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            cursor: pointer;
            color: var(--text-primary);
            font-size: 13px;
            transition: all 0.3s;
        }

        .category-tab:hover {
            background-color: var(--bg-button-hover);
        }

        .category-tab.active {
            background-color: var(--active-color);
            color: white;
            border-color: var(--active-border);
        }

        .companies-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background-color: var(--bg-primary);
        }

        .company-item {
            display: flex;
            align-items: center;
            padding: 8px;
            background-color: var(--bg-button);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .company-item:hover {
            background-color: var(--bg-button-hover);
        }

        .company-item input[type="checkbox"] {
            margin-right: 8px;
            cursor: pointer;
            accent-color: var(--active-color);
        }

        .company-item label {
            cursor: pointer;
            color: var(--text-primary);
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .selected-count {
            margin-top: 10px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .primary-button {
            padding: 12px 30px;
            background-color: var(--active-color);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background-color 0.3s;
        }

        .primary-button:hover {
            background-color: var(--active-border);
        }

        .primary-button:disabled {
            background-color: var(--bg-button);
            color: var(--text-secondary);
            cursor: not-allowed;
            border: 1px solid var(--border-color);
        }

        .metric-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .metric-button {
            padding: 10px 20px;
            background-color: var(--bg-button);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            cursor: pointer;
            color: var(--text-primary);
            transition: all 0.3s;
        }

        .metric-button:hover {
            background-color: var(--bg-button-hover);
        }

        .metric-button.active {
            background-color: var(--active-color);
            color: white;
            border-color: var(--active-border);
        }

        #chart-container {
            margin-top: 20px;
            background-color: var(--bg-secondary);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px var(--shadow-color);
        }

        .chart-frame {
            width: 100%;
            border: none;
            display: none;
            border-radius: 4px;
            min-height: 900px;
            background-color: var(--bg-primary);
        }

        .chart-frame.active {
            display: block;
        }

        .metric-button:focus {
            outline: 2px solid var(--active-color);
            outline-offset: 2px;
        }

        [data-theme="dark"] ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        [data-theme="dark"] ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        [data-theme="dark"] ::-webkit-scrollbar-thumb {
            background: var(--bg-button);
            border-radius: 5px;
        }

        [data-theme="dark"] ::-webkit-scrollbar-thumb:hover {
            background: var(--bg-button-hover);
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: var(--text-secondary);
        }

        .error-message {
            text-align: center;
            padding: 50px;
            color: #ff6b6b;
        }
    </style>
</head>
<body>
<h1>Financial Analyzer</h1>

<button class="theme-toggle" id="themeToggle">üåô Dark theme</button>

<div class="companies-section">
    <div class="companies-header">
        <h2>Select Companies to Analyze</h2>
        <div class="company-controls">
            <button class="company-control-btn" id="selectAllBtn">Select All</button>
            <button class="company-control-btn" id="deselectAllBtn">Deselect All</button>
        </div>
    </div>

    <div class="category-tabs" id="categoryTabs"></div>

    <div class="companies-grid" id="companiesGrid">
        <div class="loading">Loading companies...</div>
    </div>

    <div class="selected-count" id="selectedCount">Selected: 0 companies</div>
</div>

<div class="action-buttons">
    <button class="primary-button" id="analyzeBtn" disabled>Analyze Selected Companies</button>
</div>

<div id="metricsSection" style="display: none;">
    <div class="metric-buttons" id="metric-buttons"></div>
    <div id="chart-container"></div>
</div>

<script>
    const metrics = {{.Metrics}};
    const container = document.getElementById('chart-container');
    const buttonsContainer = document.getElementById('metric-buttons');
    const themeToggle = document.getElementById('themeToggle');
    const companiesGrid = document.getElementById('companiesGrid');
    const categoryTabs = document.getElementById('categoryTabs');
    const selectAllBtn = document.getElementById('selectAllBtn');
    const deselectAllBtn = document.getElementById('deselectAllBtn');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const metricsSection = document.getElementById('metricsSection');
    const selectedCountSpan = document.getElementById('selectedCount');

    let charts = {};
    let companiesWithCategories = [];
    let categories = [];
    let selectedCompanies = [];
    let currentCategory = 'all';

    function getCurrentTheme() {
        return document.documentElement.getAttribute('data-theme') || 'light';
    }

    function reloadAllIframes(theme) {
        if (selectedCompanies.length === 0) return;

        Object.keys(charts).forEach(metric => {
            const iframe = charts[metric];
            const wasActive = iframe.classList.contains('active');
            const companiesParam = selectedCompanies.join(',');
            iframe.src = `/chart/${metric}?theme=${theme}&companies=${companiesParam}&t=${Date.now()}`;

            if (wasActive) {
                iframe.onload = function() {
                    iframe.classList.add('active');
                };
            }
        });
    }

    function setTheme(theme) {
        const html = document.documentElement;
        if (theme === 'dark') {
            html.setAttribute('data-theme', 'dark');
            themeToggle.innerHTML = '‚òÄÔ∏è Light theme';
        } else {
            html.removeAttribute('data-theme');
            themeToggle.innerHTML = 'üåô Dark theme';
        }
        localStorage.setItem('theme', theme);
        reloadAllIframes(theme);
    }

    function toggleTheme() {
        const currentTheme = getCurrentTheme();
        setTheme(currentTheme === 'dark' ? 'light' : 'dark');
    }

    function loadTheme() {
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
            setTheme(savedTheme);
        } else {
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            setTheme(prefersDark ? 'dark' : 'light');
        }
    }

    async function loadData() {
        try {
            companiesGrid.innerHTML = '<div class="loading">Loading companies...</div>';

            await Promise.all([
                loadCompaniesWithCategories(),
                loadCategories()
            ]);

            renderCategoryTabs();
            renderCompaniesGrid();
        } catch (error) {
            console.error('Error loading data:', error);
            companiesGrid.innerHTML = '<div class="error-message">Error loading companies data. Please try again.</div>';
        }
    }

    async function loadCompaniesWithCategories() {
        const response = await fetch('/api/companies-with-categories');
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        companiesWithCategories = await response.json();
        console.log('Loaded companies:', companiesWithCategories);
    }

    async function loadCategories() {
        const response = await fetch('/api/categories');
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        categories = await response.json();
        console.log('Loaded categories:', categories);
    }

    function renderCategoryTabs() {
        categoryTabs.innerHTML = '';

        const allTab = document.createElement('button');
        allTab.className = `category-tab ${currentCategory === 'all' ? 'active' : ''}`;
        allTab.textContent = 'All Companies';
        allTab.setAttribute('data-category', 'all');
        allTab.addEventListener('click', () => {
            currentCategory = 'all';
            renderCategoryTabs();
            renderCompaniesGrid();
        });
        categoryTabs.appendChild(allTab);

        categories.forEach(category => {
            if (!category) return;

            const tab = document.createElement('button');
            tab.className = `category-tab ${category === currentCategory ? 'active' : ''}`;
            tab.textContent = category;
            tab.setAttribute('data-category', category);
            tab.addEventListener('click', () => {
                currentCategory = category;
                renderCategoryTabs();
                renderCompaniesGrid();
            });
            categoryTabs.appendChild(tab);
        });
    }

    function renderCompaniesGrid() {
        if (!companiesWithCategories || companiesWithCategories.length === 0) {
            companiesGrid.innerHTML = '<div class="loading">No companies found</div>';
            return;
        }

        companiesGrid.innerHTML = '';

        const filteredCompanies = currentCategory === 'all'
            ? companiesWithCategories
            : companiesWithCategories.filter(c => c && c.category === currentCategory);

        if (filteredCompanies.length === 0) {
            companiesGrid.innerHTML = '<div class="loading">No companies in this category</div>';
            return;
        }

        const uniqueCompanies = new Map();
        filteredCompanies.forEach(companyData => {
            if (companyData && companyData.company && !uniqueCompanies.has(companyData.company)) {
                uniqueCompanies.set(companyData.company, companyData);
            }
        });

        Array.from(uniqueCompanies.values()).forEach(companyData => {
            const item = document.createElement('div');
            item.className = 'company-item';

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = `company-${companyData.company}`;
            checkbox.value = companyData.company;
            checkbox.addEventListener('change', updateSelectedCompanies);

            const label = document.createElement('label');
            label.htmlFor = `company-${companyData.company}`;
            label.textContent = companyData.company;

            item.appendChild(checkbox);
            item.appendChild(label);

            item.addEventListener('click', (e) => {
                if (e.target !== checkbox) {
                    checkbox.checked = !checkbox.checked;
                    updateSelectedCompanies();
                }
            });

            companiesGrid.appendChild(item);
        });

        updateSelectedCompanies();
    }

    function updateSelectedCompanies() {
        const checkboxes = document.querySelectorAll('.company-item input[type="checkbox"]:checked');
        selectedCompanies = Array.from(checkboxes).map(cb => cb.value);

        selectedCountSpan.textContent = `Selected: ${selectedCompanies.length} company${selectedCompanies.length !== 1 ? 's' : ''}`;

        analyzeBtn.disabled = selectedCompanies.length === 0;

        if (selectedCompanies.length === 0) {
            metricsSection.style.display = 'none';
        }
    }

    function selectAllCompanies() {
        document.querySelectorAll('.company-item input[type="checkbox"]').forEach(cb => {
            cb.checked = true;
        });
        updateSelectedCompanies();
    }

    function deselectAllCompanies() {
        document.querySelectorAll('.company-item input[type="checkbox"]').forEach(cb => {
            cb.checked = false;
        });
        updateSelectedCompanies();
    }

    async function analyzeCompanies() {
        if (selectedCompanies.length === 0) return;

        container.innerHTML = '';
        buttonsContainer.innerHTML = '';
        charts = {};

        metricsSection.style.display = 'block';

        metrics.forEach((metric, index) => {
            const iframe = document.createElement('iframe');
            iframe.className = 'chart-frame';
            iframe.id = `chart-${metric}`;
            iframe.src = `/chart/${metric}?theme=${getCurrentTheme()}&companies=${selectedCompanies.join(',')}`;

            container.appendChild(iframe);
            charts[metric] = iframe;

            const button = document.createElement('button');
            button.className = 'metric-button' + (index === 0 ? ' active' : '');
            button.textContent = formatMetricName(metric);
            button.setAttribute('data-metric', metric);
            button.addEventListener('click', function() {
                showChart(metric);
            });
            buttonsContainer.appendChild(button);
        });

        if (metrics.length > 0) {
            showChart(metrics[0]);
        }
    }

    function showChart(metric) {
        document.querySelectorAll('.chart-frame').forEach(iframe => {
            iframe.classList.remove('active');
        });
        document.querySelectorAll('.metric-button').forEach(btn => {
            btn.classList.remove('active');
        });

        const iframe = document.getElementById(`chart-${metric}`);
        if (iframe) {
            iframe.classList.add('active');
        }

        const activeButton = Array.from(document.querySelectorAll('.metric-button')).find(
            btn => btn.getAttribute('data-metric') === metric
        );
        if (activeButton) {
            activeButton.classList.add('active');
        }
    }

    function formatMetricName(metric) {
        const names = {
            'revenue': 'Revenue',
            'net_profit': 'Net Profit',
            'ebitda': 'EBITDA',
            'pe': 'P/E Ratio',
            'roe': 'ROE (%)',
            'capitalization': 'Market Cap',
            'debt': 'Debt'
        };
        return names[metric] || metric;
    }

    themeToggle.addEventListener('click', toggleTheme);
    selectAllBtn.addEventListener('click', selectAllCompanies);
    deselectAllBtn.addEventListener('click', deselectAllCompanies);
    analyzeBtn.addEventListener('click', analyzeCompanies);

    loadData();
    loadTheme();
</script>
</body>
</html>