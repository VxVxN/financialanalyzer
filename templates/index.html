<!DOCTYPE html>
<html lang="en">
<head>
    <title>Financial Analyzer</title>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <link rel="shortcut icon" href="/static/favicon.ico" type="image/x-icon">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Analyzer â€” Refactored</title>
    <style>
        /* ---------- CSS Variables (Light / Dark) ---------- */
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f0f0f0;
            --bg-button: #f0f0f0;
            --bg-button-hover: #e0e0e0;
            --text-primary: #000000;
            --text-secondary: #333333;
            --border-color: #ccc;
            --active-color: #007bff;
            --active-border: #0056b3;
            --shadow-color: rgba(0,0,0,0.1);
            --checkbox-bg: #ffffff;
            --danger-color: #dc3545;
            --danger-hover: #c82333;
        }

        [data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-button: #3d3d3d;
            --bg-button-hover: #4d4d4d;
            --text-primary: #ffffff;
            --text-secondary: #e0e0e0;
            --border-color: #666;
            --active-color: #0056b3;
            --active-border: #004099;
            --shadow-color: rgba(255,255,255,0.1);
            --checkbox-bg: #3d3d3d;
        }

        /* ---------- Base & Layout ---------- */
        * {
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }

        h1 {
            color: var(--text-primary);
            margin-top: 0;
        }

        /* ---------- Theme Toggle ---------- */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            background-color: var(--bg-button);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            cursor: pointer;
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.3s;
            z-index: 1000;
        }

        .theme-toggle:hover {
            background-color: var(--bg-button-hover);
        }

        /* ---------- Companies Section ---------- */
        .companies-section {
            margin-bottom: 30px;
            padding: 20px;
            background-color: var(--bg-secondary);
            border-radius: 8px;
            box-shadow: 0 2px 10px var(--shadow-color);
        }

        .companies-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .companies-header h2 {
            margin: 0;
            font-size: 1.2em;
            color: var(--text-primary);
        }

        .company-controls {
            display: flex;
            gap: 10px;
        }

        .company-control-btn {
            padding: 5px 15px;
            background-color: var(--bg-button);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            cursor: pointer;
            color: var(--text-primary);
            font-size: 12px;
            transition: all 0.3s;
        }

        .company-control-btn:hover {
            background-color: var(--bg-button-hover);
        }

        /* ---------- Category Tabs ---------- */
        .category-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .category-tab {
            padding: 8px 16px;
            background-color: var(--bg-button);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            cursor: pointer;
            color: var(--text-primary);
            font-size: 13px;
            transition: all 0.3s;
        }

        .category-tab:hover {
            background-color: var(--bg-button-hover);
        }

        .category-tab.active {
            background-color: var(--active-color);
            color: white;
            border-color: var(--active-border);
        }

        /* ---------- Companies Grid ---------- */
        .companies-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 12px;
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background-color: var(--bg-primary);
        }

        .company-item {
            display: flex;
            align-items: center;
            padding: 8px;
            background-color: var(--bg-button);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            transition: all 0.2s;
            position: relative;
            gap: 6px;
        }

        .company-item:hover {
            background-color: var(--bg-button-hover);
        }

        .company-item input[type="checkbox"] {
            margin: 0;
            cursor: pointer;
            accent-color: var(--active-color);
            flex-shrink: 0;
        }

        .company-item label {
            cursor: pointer;
            color: var(--text-primary);
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
        }

        .company-color-preview {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            cursor: pointer;
            flex-shrink: 0;
        }

        .company-delete-btn {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: none;
            background-color: transparent;
            color: var(--text-secondary);
            font-size: 18px;
            line-height: 1;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            opacity: 0.6;
            flex-shrink: 0;
        }

        .company-delete-btn:hover {
            background-color: var(--danger-color);
            color: white;
            opacity: 1;
        }

        .selected-count {
            margin-top: 10px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* ---------- Action Buttons ---------- */
        .action-buttons {
            display: flex;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .primary-button {
            padding: 12px 30px;
            background-color: var(--active-color);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background-color 0.3s;
        }

        .primary-button:hover:not(:disabled) {
            background-color: var(--active-border);
        }

        .primary-button:disabled {
            background-color: var(--bg-button);
            color: var(--text-secondary);
            cursor: not-allowed;
            border: 1px solid var(--border-color);
        }

        /* ---------- Metric Buttons ---------- */
        .metric-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .metric-button {
            padding: 10px 20px;
            background-color: var(--bg-button);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            cursor: pointer;
            color: var(--text-primary);
            transition: all 0.3s;
        }

        .metric-button:hover {
            background-color: var(--bg-button-hover);
        }

        .metric-button.active {
            background-color: var(--active-color);
            color: white;
            border-color: var(--active-border);
        }

        /* ---------- Chart Container ---------- */
        #chart-container {
            margin-top: 20px;
            background-color: var(--bg-secondary);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px var(--shadow-color);
        }

        .chart-frame {
            width: 100%;
            border: none;
            display: none;
            border-radius: 4px;
            min-height: 900px;
            background-color: var(--bg-primary);
        }

        .chart-frame.active {
            display: block;
        }

        /* ---------- Loading / Error ---------- */
        .loading, .error-message {
            text-align: center;
            padding: 50px;
            color: var(--text-secondary);
        }
        .error-message {
            color: #ff6b6b;
        }

        /* ---------- Delete Confirmation Modal (inline) ---------- */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1999;
        }

        .delete-confirmation {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 20px var(--shadow-color);
            z-index: 2000;
            min-width: 300px;
        }

        .delete-confirmation p {
            margin: 0 0 20px 0;
            color: var(--text-primary);
            font-size: 16px;
        }

        .delete-confirmation-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .delete-confirm-btn {
            background-color: var(--danger-color);
            color: white;
        }
        .delete-confirm-btn:hover {
            background-color: var(--danger-hover);
        }
        .delete-cancel-btn {
            background-color: var(--bg-button);
            color: var(--text-primary);
        }
        .delete-cancel-btn:hover {
            background-color: var(--bg-button-hover);
        }

        /* Color Modal */
        .color-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 4px 20px var(--shadow-color);
            z-index: 2000;
            min-width: 400px;
        }

        .color-modal h3 {
            margin: 0 0 20px 0;
            color: var(--text-primary);
            font-size: 20px;
        }

        .color-picker-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 20px;
        }

        .color-picker-container input[type="color"] {
            width: 100%;
            height: 50px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            cursor: pointer;
            background-color: var(--bg-secondary);
        }

        .color-presets {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
        }

        .color-preset {
            width: 40px;
            height: 40px;
            border-radius: 4px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
        }

        .color-preset:hover {
            transform: scale(1.1);
            border-color: var(--active-color);
        }

        .color-preset.selected {
            border-color: var(--active-color);
            box-shadow: 0 0 0 2px var(--active-color);
        }

        .color-modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .color-save-btn {
            background-color: var(--active-color);
            color: white;
            padding: 10px 20px;
            font-size: 15px;
        }

        .color-save-btn:hover {
            background-color: var(--active-border);
        }

        .color-cancel-btn {
            background-color: var(--bg-button);
            color: var(--text-primary);
            padding: 10px 20px;
            font-size: 15px;
        }

        .color-cancel-btn:hover {
            background-color: var(--bg-button-hover);
        }

        .color-reset-btn {
            background-color: var(--danger-color);
            color: white;
            margin-right: auto;
            padding: 10px 20px;
            font-size: 15px;
        }

        /* ---------- Scrollbar for dark theme ---------- */
        [data-theme="dark"] ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        [data-theme="dark"] ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }
        [data-theme="dark"] ::-webkit-scrollbar-thumb {
            background: var(--bg-button);
            border-radius: 5px;
        }
        [data-theme="dark"] ::-webkit-scrollbar-thumb:hover {
            background: var(--bg-button-hover);
        }

        .company-note-btn {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: none;
            background-color: transparent;
            color: var(--text-secondary);
            font-size: 16px;
            line-height: 1;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            opacity: 0.6;
            flex-shrink: 0;
        }

        .company-note-btn:hover {
            background-color: var(--active-color);
            color: white;
            opacity: 1;
        }

        .company-note-btn.has-note {
            color: var(--active-color);
            opacity: 1;
        }

        .company-note-btn.has-note:hover {
            background-color: var(--active-color);
            color: white;
        }

        /* Note Modal */
        .note-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 4px 20px var(--shadow-color);
            z-index: 2000;
            min-width: 600px;
            max-width: 800px;
            width: 80%;
        }

        .note-modal h3 {
            margin: 0 0 20px 0;
            color: var(--text-primary);
            font-size: 20px;
        }

        .note-modal textarea {
            width: 100%;
            min-height: 250px;
            padding: 15px;
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-family: inherit;
            font-size: 15px;
            resize: vertical;
            margin-bottom: 20px;
        }

        .note-modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .note-save-btn {
            background-color: var(--active-color);
            color: white;
            padding: 10px 20px;
            font-size: 15px;
        }

        .note-save-btn:hover {
            background-color: var(--active-border);
        }

        .note-cancel-btn {
            background-color: var(--bg-button);
            color: var(--text-primary);
            padding: 10px 20px;
            font-size: 15px;
        }

        .note-cancel-btn:hover {
            background-color: var(--bg-button-hover);
        }

        .note-delete-btn {
            background-color: var(--danger-color);
            color: white;
            margin-right: auto;
            padding: 10px 20px;
            font-size: 15px;
        }

        .note-timestamp {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 15px;
            text-align: right;
        }
    </style>
</head>
<body>
<h1>Financial Analyzer</h1>
<button class="theme-toggle" id="themeToggle">ðŸŒ™ Dark theme</button>

<!-- Companies selection panel -->
<section class="companies-section">
    <div class="companies-header">
        <h2>Select Companies to Analyze</h2>
        <div class="company-controls">
            <button class="company-control-btn" id="selectAllBtn">Select All</button>
            <button class="company-control-btn" id="deselectAllBtn">Deselect All</button>
        </div>
    </div>

    <!-- Category tabs will be injected here -->
    <div class="category-tabs" id="categoryTabs"></div>

    <!-- Companies grid -->
    <div class="companies-grid" id="companiesGrid">
        <div class="loading">Loading companies...</div>
    </div>

    <div class="selected-count" id="selectedCount">Selected: 0 companies</div>
</section>

<!-- Main action button -->
<div class="action-buttons">
    <button class="primary-button" id="analyzeBtn" disabled>Analyze Selected Companies</button>
</div>

<!-- Metrics section (hidden until analysis) -->
<div id="metricsSection" style="display: none;">
    <div class="metric-buttons" id="metric-buttons"></div>
    <div id="chart-container"></div>
</div>

<script>
    (function() {
        // ---------- DATA FROM BACKEND ----------
        const metrics = {{.Metrics}};   // injected by Go template

        // ---------- DOM ELEMENTS ----------
        const elements = {
            themeToggle: document.getElementById('themeToggle'),
            companiesGrid: document.getElementById('companiesGrid'),
            categoryTabs: document.getElementById('categoryTabs'),
            selectAllBtn: document.getElementById('selectAllBtn'),
            deselectAllBtn: document.getElementById('deselectAllBtn'),
            analyzeBtn: document.getElementById('analyzeBtn'),
            metricsSection: document.getElementById('metricsSection'),
            selectedCountSpan: document.getElementById('selectedCount'),
            container: document.getElementById('chart-container'),
            buttonsContainer: document.getElementById('metric-buttons')
        };

        // ---------- STATE ----------
        let state = {
            companiesWithCategories: [],    // [{ company, category }]
            categories: [],                 // string[]
            selectedCompanies: [],           // string[] (company names)
            currentCategory: 'all',
            charts: {},                       // metric -> iframe element
            companyColors: {}                  // company -> color
        };

        // ---------- THEME MANAGEMENT ----------
        function getCurrentTheme() {
            return document.documentElement.getAttribute('data-theme') || 'light';
        }

        function setTheme(theme) {
            const html = document.documentElement;
            if (theme === 'dark') {
                html.setAttribute('data-theme', 'dark');
                elements.themeToggle.innerHTML = 'â˜€ï¸ Light theme';
            } else {
                html.removeAttribute('data-theme');
                elements.themeToggle.innerHTML = 'ðŸŒ™ Dark theme';
            }
            localStorage.setItem('theme', theme);
            reloadAllIframes(theme);
        }

        function toggleTheme() {
            const current = getCurrentTheme();
            setTheme(current === 'dark' ? 'light' : 'dark');
        }

        function loadSavedTheme() {
            const saved = localStorage.getItem('theme');
            if (saved) {
                setTheme(saved);
            } else {
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                setTheme(prefersDark ? 'dark' : 'light');
            }
        }

        // ---------- DATA FETCHING ----------
        async function loadCompaniesWithCategories() {
            const resp = await fetch('/api/companies-with-categories');
            if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
            return await resp.json();
        }

        async function loadCategories() {
            const resp = await fetch('/api/categories');
            if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
            return await resp.json();
        }

        async function loadAllCompanyColors() {
            const companies = state.companiesWithCategories.map(c => c.company);
            const uniqueCompanies = [...new Set(companies)];

            for (const company of uniqueCompanies) {
                try {
                    const resp = await fetch(`/api/company-color?company=${encodeURIComponent(company)}`);
                    if (resp.ok) {
                        const data = await resp.json();
                        if (data.color) {
                            state.companyColors[company] = data.color;
                        }
                    }
                } catch (err) {
                    console.error(`Error loading color for ${company}:`, err);
                }
            }
        }

        async function loadData() {
            try {
                elements.companiesGrid.innerHTML = '<div class="loading">Loading companies...</div>';

                const [companies, cats] = await Promise.all([
                    loadCompaniesWithCategories(),
                    loadCategories()
                ]);

                state.companiesWithCategories = companies;
                state.categories = cats;

                await loadAllCompanyColors();

                renderCategoryTabs();
                renderCompaniesGrid();
            } catch (err) {
                console.error('loadData error:', err);
                elements.companiesGrid.innerHTML = '<div class="error-message">Error loading companies. Please refresh.</div>';
            }
        }

        // ---------- COLOR MANAGEMENT ----------
        const colorPresets = [
            '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEEAD', '#D4A5A5',
            '#9B59B6', '#3498DB', '#E67E22', '#2ECC71', '#E74C3C', '#F1C40F',
            '#1ABC9C', '#E84342', '#6C5B7B', '#F8A5C2', '#546E7A', '#FFA726'
        ];

        function getCompanyColor(company) {
            if (state.companyColors[company]) {
                return state.companyColors[company];
            }
            const hash = company.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
            return colorPresets[hash % colorPresets.length];
        }

        async function openColorModal(company) {
            const overlay = document.createElement('div');
            overlay.className = 'overlay';

            const modal = document.createElement('div');
            modal.className = 'color-modal';

            const currentColor = getCompanyColor(company);

            const presetsHtml = colorPresets.map(color =>
                `<div class="color-preset" style="background-color: ${color};" data-color="${color}"></div>`
            ).join('');

            modal.innerHTML = `
                <h3>Choose Color for ${company}</h3>
                <div class="color-picker-container">
                    <input type="color" id="colorPicker" value="${currentColor}">
                    <div class="color-presets">
                        ${presetsHtml}
                    </div>
                </div>
                <div class="color-modal-buttons">
                    <button class="color-reset-btn" id="resetColorBtn">Reset</button>
                    <button class="color-cancel-btn" id="cancelColorBtn">Cancel</button>
                    <button class="color-save-btn" id="saveColorBtn">Save</button>
                </div>
            `;

            document.body.append(overlay, modal);

            const colorPicker = modal.querySelector('#colorPicker');
            const presets = modal.querySelectorAll('.color-preset');
            const saveBtn = modal.querySelector('#saveColorBtn');
            const cancelBtn = modal.querySelector('#cancelColorBtn');
            const resetBtn = modal.querySelector('#resetColorBtn');

            presets.forEach(preset => {
                preset.addEventListener('click', () => {
                    const color = preset.dataset.color;
                    colorPicker.value = color;
                    presets.forEach(p => p.classList.remove('selected'));
                    preset.classList.add('selected');
                });
            });

            colorPicker.addEventListener('input', () => {
                presets.forEach(p => p.classList.remove('selected'));
            });

            const cleanup = () => {
                overlay.remove();
                modal.remove();
            };

            cancelBtn.addEventListener('click', cleanup);
            overlay.addEventListener('click', cleanup);

            resetBtn.addEventListener('click', async () => {
                try {
                    const resp = await fetch(`/api/company-color?company=${encodeURIComponent(company)}`, {
                        method: 'DELETE'
                    });

                    if (!resp.ok) throw new Error('Failed to reset color');

                    delete state.companyColors[company];
                    updateColorPreview(company);
                    cleanup();
                } catch (err) {
                    console.error('Error resetting color:', err);
                    alert('Failed to reset color');
                }
            });

            saveBtn.addEventListener('click', async () => {
                const color = colorPicker.value;

                try {
                    const resp = await fetch('/api/company-color', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ company, color })
                    });

                    if (!resp.ok) throw new Error('Failed to save color');

                    state.companyColors[company] = color;
                    updateColorPreview(company);
                    cleanup();
                } catch (err) {
                    console.error('Error saving color:', err);
                    alert('Failed to save color');
                }
            });
        }

        function updateColorPreview(company) {
            const colorPreview = document.querySelector(`.company-item label[for="company-${company}"] + .company-color-preview`);
            if (colorPreview) {
                colorPreview.style.backgroundColor = getCompanyColor(company);
            }
        }

        // ---------- RENDERING ----------
        function renderCategoryTabs() {
            const { categoryTabs } = elements;
            categoryTabs.innerHTML = '';

            const allTab = createTab('All Companies', 'all', state.currentCategory === 'all');
            categoryTabs.appendChild(allTab);

            state.categories.filter(Boolean).forEach(cat => {
                const tab = createTab(cat, cat, state.currentCategory === cat);
                categoryTabs.appendChild(tab);
            });

            function createTab(label, value, isActive) {
                const btn = document.createElement('button');
                btn.className = `category-tab ${isActive ? 'active' : ''}`;
                btn.textContent = label;
                btn.setAttribute('data-category', value);
                btn.addEventListener('click', () => {
                    state.currentCategory = value;
                    renderCategoryTabs();
                    renderCompaniesGrid();
                });
                return btn;
            }
        }

        function renderCompaniesGrid() {
            const { companiesGrid } = elements;
            if (!state.companiesWithCategories.length) {
                companiesGrid.innerHTML = '<div class="loading">No companies found</div>';
                return;
            }

            const filtered = state.currentCategory === 'all'
                ? state.companiesWithCategories
                : state.companiesWithCategories.filter(c => c && c.category === state.currentCategory);

            const uniqueMap = new Map();
            filtered.forEach(item => {
                if (item && item.company && !uniqueMap.has(item.company)) {
                    uniqueMap.set(item.company, item);
                }
            });
            const uniqueCompanies = Array.from(uniqueMap.values());

            if (uniqueCompanies.length === 0) {
                companiesGrid.innerHTML = '<div class="loading">No companies in this category</div>';
                return;
            }

            companiesGrid.innerHTML = '';
            uniqueCompanies.forEach(companyData => {
                const companyName = companyData.company;
                const item = document.createElement('div');
                item.className = 'company-item';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `company-${companyName}`;
                checkbox.value = companyName;
                checkbox.addEventListener('change', updateSelectedCompanies);

                const label = document.createElement('label');
                label.htmlFor = `company-${companyName}`;
                label.textContent = companyName;

                const colorPreview = document.createElement('div');
                colorPreview.className = 'company-color-preview';
                colorPreview.style.backgroundColor = getCompanyColor(companyName);
                colorPreview.title = 'Change color';
                colorPreview.addEventListener('click', (e) => {
                    e.stopPropagation();
                    openColorModal(companyName);
                });

                const noteBtn = document.createElement('button');
                noteBtn.className = 'company-note-btn';
                noteBtn.innerHTML = 'ðŸ“';
                noteBtn.title = 'Add/edit note';
                noteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    openNoteModal(companyName);
                });

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'company-delete-btn';
                deleteBtn.innerHTML = 'Ã—';
                deleteBtn.title = 'Delete company';
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    confirmDeleteCompany(companyName);
                });

                item.append(checkbox, label, colorPreview, noteBtn, deleteBtn);
                companiesGrid.appendChild(item);
            });

            const checkboxes = companiesGrid.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(cb => {
                cb.checked = state.selectedCompanies.includes(cb.value);
            });
            updateSelectedCompanies();

            loadAllNotes();
        }

        // Notes state
        let companyNotes = {};

        async function loadAllNotes() {
            const companies = state.companiesWithCategories.map(c => c.company);
            const uniqueCompanies = [...new Set(companies)];

            for (const company of uniqueCompanies) {
                try {
                    const resp = await fetch(`/api/company-note?company=${encodeURIComponent(company)}`);
                    if (resp.ok) {
                        const data = await resp.json();
                        if (data.note) {
                            companyNotes[company] = {
                                note: data.note,
                                timestamp: Date.now()
                            };
                            updateNoteButton(company);
                        }
                    }
                } catch (err) {
                    console.error(`Error loading note for ${company}:`, err);
                }
            }
        }

        function updateNoteButton(company) {
            const noteBtn = document.querySelector(`.company-item label[for="company-${company}"] + .company-color-preview + .company-note-btn`);
            if (noteBtn && companyNotes[company]) {
                noteBtn.classList.add('has-note');
            }
        }

        async function openNoteModal(company) {
            const overlay = document.createElement('div');
            overlay.className = 'overlay';

            const modal = document.createElement('div');
            modal.className = 'note-modal';

            let existingNote = '';
            try {
                const resp = await fetch(`/api/company-note?company=${encodeURIComponent(company)}`);
                if (resp.ok) {
                    const data = await resp.json();
                    existingNote = data.note || '';
                }
            } catch (err) {
                console.error('Error loading note:', err);
            }

            modal.innerHTML = `
        <h3>Note for ${company}</h3>
        <textarea id="noteText" placeholder="Enter your notes about this company...">${escapeHtml(existingNote)}</textarea>
        <div class="note-modal-buttons">
            ${existingNote ? '<button class="note-delete-btn" id="deleteNoteBtn">Delete</button>' : ''}
            <button class="note-cancel-btn" id="cancelNoteBtn">Cancel</button>
            <button class="note-save-btn" id="saveNoteBtn">Save</button>
        </div>
    `;

            document.body.append(overlay, modal);

            const textarea = modal.querySelector('#noteText');
            const saveBtn = modal.querySelector('#saveNoteBtn');
            const cancelBtn = modal.querySelector('#cancelNoteBtn');
            const deleteBtn = modal.querySelector('#deleteNoteBtn');

            const cleanup = () => {
                overlay.remove();
                modal.remove();
            };

            cancelBtn.addEventListener('click', cleanup);
            overlay.addEventListener('click', cleanup);

            if (deleteBtn) {
                deleteBtn.addEventListener('click', async () => {
                    try {
                        const resp = await fetch(`/api/company-note?company=${encodeURIComponent(company)}`, {
                            method: 'DELETE'
                        });

                        if (!resp.ok) throw new Error('Failed to delete note');

                        delete companyNotes[company];
                        updateNoteButton(company);
                        cleanup();
                    } catch (err) {
                        console.error('Error deleting note:', err);
                        alert('Failed to delete note');
                    }
                });
            }

            saveBtn.addEventListener('click', async () => {
                const note = textarea.value.trim();

                try {
                    const resp = await fetch('/api/company-note', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ company, note })
                    });

                    if (!resp.ok) throw new Error('Failed to save note');

                    if (note) {
                        companyNotes[company] = {
                            note: note,
                            timestamp: Date.now()
                        };
                    } else {
                        delete companyNotes[company];
                    }

                    updateNoteButton(company);
                    cleanup();
                } catch (err) {
                    console.error('Error saving note:', err);
                    alert('Failed to save note');
                }
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ---------- SELECTION HANDLING ----------
        function updateSelectedCompanies() {
            const checkboxes = document.querySelectorAll('.company-item input[type="checkbox"]:checked');
            state.selectedCompanies = Array.from(checkboxes).map(cb => cb.value);

            const count = state.selectedCompanies.length;
            elements.selectedCountSpan.textContent = `Selected: ${count} company${count !== 1 ? 's' : ''}`;
            elements.analyzeBtn.disabled = count === 0;

            if (count === 0) {
                elements.metricsSection.style.display = 'none';
            }
        }

        function selectAllCompanies() {
            document.querySelectorAll('.company-item input[type="checkbox"]').forEach(cb => cb.checked = true);
            updateSelectedCompanies();
        }

        function deselectAllCompanies() {
            document.querySelectorAll('.company-item input[type="checkbox"]').forEach(cb => cb.checked = false);
            updateSelectedCompanies();
        }

        // ---------- ANALYSIS & CHARTS ----------
        async function analyzeCompanies() {
            if (state.selectedCompanies.length === 0) return;

            const { container, buttonsContainer, metricsSection } = elements;
            container.innerHTML = '';
            buttonsContainer.innerHTML = '';
            state.charts = {};

            metricsSection.style.display = 'block';

            const colors = state.selectedCompanies.map(company => getCompanyColor(company)).join(',');

            metrics.forEach((metric, index) => {
                const iframe = document.createElement('iframe');
                iframe.className = 'chart-frame';
                iframe.id = `chart-${metric}`;
                iframe.src = `/chart/${metric}?theme=${getCurrentTheme()}&companies=${state.selectedCompanies.join(',')}&colors=${colors}`;
                container.appendChild(iframe);
                state.charts[metric] = iframe;

                const btn = document.createElement('button');
                btn.className = `metric-button ${index === 0 ? 'active' : ''}`;
                btn.textContent = formatMetricName(metric);
                btn.setAttribute('data-metric', metric);
                btn.addEventListener('click', () => showChart(metric));
                buttonsContainer.appendChild(btn);
            });

            if (metrics.length) showChart(metrics[0]);
        }

        function showChart(metric) {
            document.querySelectorAll('.chart-frame').forEach(ifr => ifr.classList.remove('active'));
            document.querySelectorAll('.metric-button').forEach(btn => btn.classList.remove('active'));

            const iframe = document.getElementById(`chart-${metric}`);
            if (iframe) iframe.classList.add('active');

            const activeBtn = Array.from(document.querySelectorAll('.metric-button')).find(
                btn => btn.getAttribute('data-metric') === metric
            );
            if (activeBtn) activeBtn.classList.add('active');
        }

        function formatMetricName(metric) {
            const names = {
                'revenue': 'Revenue',
                'net_profit': 'Net Profit',
                'ebitda': 'EBITDA',
                'pe': 'P/E Ratio',
                'roe': 'ROE (%)',
                'capitalization': 'Market Cap',
                'debt': 'Debt'
            };
            return names[metric] || metric;
        }

        function reloadAllIframes(theme) {
            if (state.selectedCompanies.length === 0) return;

            const colors = state.selectedCompanies.map(company => getCompanyColor(company)).join(',');

            Object.entries(state.charts).forEach(([metric, iframe]) => {
                const wasActive = iframe.classList.contains('active');
                iframe.src = `/chart/${metric}?theme=${theme}&companies=${state.selectedCompanies.join(',')}&colors=${colors}&t=${Date.now()}`;
                if (wasActive) {
                    iframe.onload = () => iframe.classList.add('active');
                }
            });
        }

        // ---------- DELETE COMPANY (inline confirmation) ----------
        function confirmDeleteCompany(companyName) {
            const overlay = document.createElement('div');
            overlay.className = 'overlay';

            const confirmBox = document.createElement('div');
            confirmBox.className = 'delete-confirmation';
            confirmBox.innerHTML = `
                    <p>Are you sure you want to delete "${companyName}"?</p>
                    <div class="delete-confirmation-buttons">
                        <button class="delete-cancel-btn">Cancel</button>
                        <button class="delete-confirm-btn">Delete</button>
                    </div>
                `;

            document.body.append(overlay, confirmBox);

            const cancelBtn = confirmBox.querySelector('.delete-cancel-btn');
            const deleteBtn = confirmBox.querySelector('.delete-confirm-btn');

            const cleanup = () => {
                overlay.remove();
                confirmBox.remove();
            };

            cancelBtn.addEventListener('click', cleanup);
            overlay.addEventListener('click', cleanup);

            deleteBtn.addEventListener('click', async () => {
                try {
                    const resp = await fetch('/api/companies', {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ company: companyName })
                    });

                    if (!resp.ok) {
                        const errText = await resp.text();
                        throw new Error(errText);
                    }

                    await fetch(`/api/company-note?company=${encodeURIComponent(companyName)}`, {
                        method: 'DELETE'
                    });

                    await fetch(`/api/company-color?company=${encodeURIComponent(companyName)}`, {
                        method: 'DELETE'
                    });

                    cleanup();
                    delete companyNotes[companyName];
                    delete state.companyColors[companyName];
                    await loadData();
                    deselectAllCompanies();
                    elements.metricsSection.style.display = 'none';
                    alert(`Company "${companyName}" deleted successfully.`);
                } catch (err) {
                    console.error('Delete error:', err);
                    alert(`Error deleting company: ${err.message}`);
                    cleanup();
                }
            });
        }

        // ---------- EVENT LISTENERS ----------
        elements.themeToggle.addEventListener('click', toggleTheme);
        elements.selectAllBtn.addEventListener('click', selectAllCompanies);
        elements.deselectAllBtn.addEventListener('click', deselectAllCompanies);
        elements.analyzeBtn.addEventListener('click', analyzeCompanies);

        // ---------- INITIALIZATION ----------
        loadData();
        loadSavedTheme();
    })();
</script>
</body>
</html>