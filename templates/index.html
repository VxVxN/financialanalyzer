<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Analyzer ‚Äî Refactored</title>
    <style>
        /* ---------- CSS Variables (Light / Dark) ---------- */
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f0f0f0;
            --bg-button: #f0f0f0;
            --bg-button-hover: #e0e0e0;
            --text-primary: #000000;
            --text-secondary: #333333;
            --border-color: #ccc;
            --active-color: #007bff;
            --active-border: #0056b3;
            --shadow-color: rgba(0,0,0,0.1);
            --checkbox-bg: #ffffff;
            --danger-color: #dc3545;
            --danger-hover: #c82333;
        }

        [data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-button: #3d3d3d;
            --bg-button-hover: #4d4d4d;
            --text-primary: #ffffff;
            --text-secondary: #e0e0e0;
            --border-color: #666;
            --active-color: #0056b3;
            --active-border: #004099;
            --shadow-color: rgba(255,255,255,0.1);
            --checkbox-bg: #3d3d3d;
        }

        /* ---------- Base & Layout ---------- */
        * {
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }

        h1 {
            color: var(--text-primary);
            margin-top: 0;
        }

        /* ---------- Theme Toggle ---------- */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            background-color: var(--bg-button);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            cursor: pointer;
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.3s;
            z-index: 1000;
        }

        .theme-toggle:hover {
            background-color: var(--bg-button-hover);
        }

        /* ---------- Companies Section ---------- */
        .companies-section {
            margin-bottom: 30px;
            padding: 20px;
            background-color: var(--bg-secondary);
            border-radius: 8px;
            box-shadow: 0 2px 10px var(--shadow-color);
        }

        .companies-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .companies-header h2 {
            margin: 0;
            font-size: 1.2em;
            color: var(--text-primary);
        }

        .company-controls {
            display: flex;
            gap: 10px;
        }

        .company-control-btn {
            padding: 5px 15px;
            background-color: var(--bg-button);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            cursor: pointer;
            color: var(--text-primary);
            font-size: 12px;
            transition: all 0.3s;
        }

        .company-control-btn:hover {
            background-color: var(--bg-button-hover);
        }

        /* ---------- Category Tabs ---------- */
        .category-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .category-tab {
            padding: 8px 16px;
            background-color: var(--bg-button);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            cursor: pointer;
            color: var(--text-primary);
            font-size: 13px;
            transition: all 0.3s;
        }

        .category-tab:hover {
            background-color: var(--bg-button-hover);
        }

        .category-tab.active {
            background-color: var(--active-color);
            color: white;
            border-color: var(--active-border);
        }

        /* ---------- Companies Grid ---------- */
        .companies-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background-color: var(--bg-primary);
        }

        .company-item {
            display: flex;
            align-items: center;
            padding: 8px;
            background-color: var(--bg-button);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            transition: all 0.2s;
            position: relative;
            gap: 6px;
        }

        .company-item:hover {
            background-color: var(--bg-button-hover);
        }

        .company-item input[type="checkbox"] {
            margin: 0;
            cursor: pointer;
            accent-color: var(--active-color);
            flex-shrink: 0;
        }

        .company-item label {
            cursor: pointer;
            color: var(--text-primary);
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
        }

        .company-delete-btn {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: none;
            background-color: transparent;
            color: var(--text-secondary);
            font-size: 18px;
            line-height: 1;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            opacity: 0.6;
            flex-shrink: 0;
        }

        .company-delete-btn:hover {
            background-color: var(--danger-color);
            color: white;
            opacity: 1;
        }

        .selected-count {
            margin-top: 10px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* ---------- Action Buttons ---------- */
        .action-buttons {
            display: flex;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .primary-button {
            padding: 12px 30px;
            background-color: var(--active-color);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background-color 0.3s;
        }

        .primary-button:hover:not(:disabled) {
            background-color: var(--active-border);
        }

        .primary-button:disabled {
            background-color: var(--bg-button);
            color: var(--text-secondary);
            cursor: not-allowed;
            border: 1px solid var(--border-color);
        }

        /* ---------- Metric Buttons ---------- */
        .metric-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .metric-button {
            padding: 10px 20px;
            background-color: var(--bg-button);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            cursor: pointer;
            color: var(--text-primary);
            transition: all 0.3s;
        }

        .metric-button:hover {
            background-color: var(--bg-button-hover);
        }

        .metric-button.active {
            background-color: var(--active-color);
            color: white;
            border-color: var(--active-border);
        }

        /* ---------- Chart Container ---------- */
        #chart-container {
            margin-top: 20px;
            background-color: var(--bg-secondary);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px var(--shadow-color);
        }

        .chart-frame {
            width: 100%;
            border: none;
            display: none;
            border-radius: 4px;
            min-height: 900px;
            background-color: var(--bg-primary);
        }

        .chart-frame.active {
            display: block;
        }

        /* ---------- Loading / Error ---------- */
        .loading, .error-message {
            text-align: center;
            padding: 50px;
            color: var(--text-secondary);
        }
        .error-message {
            color: #ff6b6b;
        }

        /* ---------- Delete Confirmation Modal (inline) ---------- */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1999;
        }

        .delete-confirmation {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 20px var(--shadow-color);
            z-index: 2000;
            min-width: 300px;
        }

        .delete-confirmation p {
            margin: 0 0 20px 0;
            color: var(--text-primary);
            font-size: 16px;
        }

        .delete-confirmation-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .delete-confirm-btn {
            background-color: var(--danger-color);
            color: white;
        }
        .delete-confirm-btn:hover {
            background-color: var(--danger-hover);
        }
        .delete-cancel-btn {
            background-color: var(--bg-button);
            color: var(--text-primary);
        }
        .delete-cancel-btn:hover {
            background-color: var(--bg-button-hover);
        }

        /* ---------- Scrollbar for dark theme ---------- */
        [data-theme="dark"] ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        [data-theme="dark"] ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }
        [data-theme="dark"] ::-webkit-scrollbar-thumb {
            background: var(--bg-button);
            border-radius: 5px;
        }
        [data-theme="dark"] ::-webkit-scrollbar-thumb:hover {
            background: var(--bg-button-hover);
        }
    </style>
</head>
<body>
<h1>Financial Analyzer</h1>
<button class="theme-toggle" id="themeToggle">üåô Dark theme</button>

<!-- Companies selection panel -->
<section class="companies-section">
    <div class="companies-header">
        <h2>Select Companies to Analyze</h2>
        <div class="company-controls">
            <button class="company-control-btn" id="selectAllBtn">Select All</button>
            <button class="company-control-btn" id="deselectAllBtn">Deselect All</button>
        </div>
    </div>

    <!-- Category tabs will be injected here -->
    <div class="category-tabs" id="categoryTabs"></div>

    <!-- Companies grid -->
    <div class="companies-grid" id="companiesGrid">
        <div class="loading">Loading companies...</div>
    </div>

    <div class="selected-count" id="selectedCount">Selected: 0 companies</div>
</section>

<!-- Main action button -->
<div class="action-buttons">
    <button class="primary-button" id="analyzeBtn" disabled>Analyze Selected Companies</button>
</div>

<!-- Metrics section (hidden until analysis) -->
<div id="metricsSection" style="display: none;">
    <div class="metric-buttons" id="metric-buttons"></div>
    <div id="chart-container"></div>
</div>

<script>
    (function() {
        // ---------- DATA FROM BACKEND ----------
        const metrics = {{.Metrics}};   // injected by Go template

        // ---------- DOM ELEMENTS ----------
        const elements = {
            themeToggle: document.getElementById('themeToggle'),
            companiesGrid: document.getElementById('companiesGrid'),
            categoryTabs: document.getElementById('categoryTabs'),
            selectAllBtn: document.getElementById('selectAllBtn'),
            deselectAllBtn: document.getElementById('deselectAllBtn'),
            analyzeBtn: document.getElementById('analyzeBtn'),
            metricsSection: document.getElementById('metricsSection'),
            selectedCountSpan: document.getElementById('selectedCount'),
            container: document.getElementById('chart-container'),
            buttonsContainer: document.getElementById('metric-buttons')
        };

        // ---------- STATE ----------
        let state = {
            companiesWithCategories: [],    // [{ company, category }]
            categories: [],                 // string[]
            selectedCompanies: [],           // string[] (company names)
            currentCategory: 'all',
            charts: {}                       // metric -> iframe element
        };

        // ---------- THEME MANAGEMENT ----------
        function getCurrentTheme() {
            return document.documentElement.getAttribute('data-theme') || 'light';
        }

        function setTheme(theme) {
            const html = document.documentElement;
            if (theme === 'dark') {
                html.setAttribute('data-theme', 'dark');
                elements.themeToggle.innerHTML = '‚òÄÔ∏è Light theme';
            } else {
                html.removeAttribute('data-theme');
                elements.themeToggle.innerHTML = 'üåô Dark theme';
            }
            localStorage.setItem('theme', theme);
            reloadAllIframes(theme);
        }

        function toggleTheme() {
            const current = getCurrentTheme();
            setTheme(current === 'dark' ? 'light' : 'dark');
        }

        function loadSavedTheme() {
            const saved = localStorage.getItem('theme');
            if (saved) {
                setTheme(saved);
            } else {
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                setTheme(prefersDark ? 'dark' : 'light');
            }
        }

        // ---------- DATA FETCHING ----------
        async function loadCompaniesWithCategories() {
            const resp = await fetch('/api/companies-with-categories');
            if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
            return await resp.json();
        }

        async function loadCategories() {
            const resp = await fetch('/api/categories');
            if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
            return await resp.json();
        }

        async function loadData() {
            try {
                elements.companiesGrid.innerHTML = '<div class="loading">Loading companies...</div>';

                const [companies, cats] = await Promise.all([
                    loadCompaniesWithCategories(),
                    loadCategories()
                ]);

                state.companiesWithCategories = companies;
                state.categories = cats;

                renderCategoryTabs();
                renderCompaniesGrid();
            } catch (err) {
                console.error('loadData error:', err);
                elements.companiesGrid.innerHTML = '<div class="error-message">Error loading companies. Please refresh.</div>';
            }
        }

        // ---------- RENDERING ----------
        function renderCategoryTabs() {
            const { categoryTabs } = elements;
            categoryTabs.innerHTML = '';

            // "All Companies" tab
            const allTab = createTab('All Companies', 'all', state.currentCategory === 'all');
            categoryTabs.appendChild(allTab);

            // Category tabs
            state.categories.filter(Boolean).forEach(cat => {
                const tab = createTab(cat, cat, state.currentCategory === cat);
                categoryTabs.appendChild(tab);
            });

            function createTab(label, value, isActive) {
                const btn = document.createElement('button');
                btn.className = `category-tab ${isActive ? 'active' : ''}`;
                btn.textContent = label;
                btn.setAttribute('data-category', value);
                btn.addEventListener('click', () => {
                    state.currentCategory = value;
                    renderCategoryTabs();
                    renderCompaniesGrid();
                });
                return btn;
            }
        }

        function renderCompaniesGrid() {
            const { companiesGrid } = elements;
            if (!state.companiesWithCategories.length) {
                companiesGrid.innerHTML = '<div class="loading">No companies found</div>';
                return;
            }

            // Filter by category
            const filtered = state.currentCategory === 'all'
                ? state.companiesWithCategories
                : state.companiesWithCategories.filter(c => c && c.category === state.currentCategory);

            // Remove duplicates (by company name)
            const uniqueMap = new Map();
            filtered.forEach(item => {
                if (item && item.company && !uniqueMap.has(item.company)) {
                    uniqueMap.set(item.company, item);
                }
            });
            const uniqueCompanies = Array.from(uniqueMap.values());

            if (uniqueCompanies.length === 0) {
                companiesGrid.innerHTML = '<div class="loading">No companies in this category</div>';
                return;
            }

            // Build grid
            companiesGrid.innerHTML = '';
            uniqueCompanies.forEach(companyData => {
                const companyName = companyData.company;
                const item = document.createElement('div');
                item.className = 'company-item';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `company-${companyName}`;
                checkbox.value = companyName;
                checkbox.addEventListener('change', updateSelectedCompanies);

                const label = document.createElement('label');
                label.htmlFor = `company-${companyName}`;
                label.textContent = companyName;

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'company-delete-btn';
                deleteBtn.innerHTML = '√ó';
                deleteBtn.title = 'Delete company';
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    confirmDeleteCompany(companyName);
                });

                item.append(checkbox, label, deleteBtn);
                companiesGrid.appendChild(item);
            });

            // Restore checked state
            const checkboxes = companiesGrid.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(cb => {
                cb.checked = state.selectedCompanies.includes(cb.value);
            });
            updateSelectedCompanies();
        }

        // ---------- SELECTION HANDLING ----------
        function updateSelectedCompanies() {
            const checkboxes = document.querySelectorAll('.company-item input[type="checkbox"]:checked');
            state.selectedCompanies = Array.from(checkboxes).map(cb => cb.value);

            const count = state.selectedCompanies.length;
            elements.selectedCountSpan.textContent = `Selected: ${count} company${count !== 1 ? 's' : ''}`;
            elements.analyzeBtn.disabled = count === 0;

            if (count === 0) {
                elements.metricsSection.style.display = 'none';
            }
        }

        function selectAllCompanies() {
            document.querySelectorAll('.company-item input[type="checkbox"]').forEach(cb => cb.checked = true);
            updateSelectedCompanies();
        }

        function deselectAllCompanies() {
            document.querySelectorAll('.company-item input[type="checkbox"]').forEach(cb => cb.checked = false);
            updateSelectedCompanies();
        }

        // ---------- ANALYSIS & CHARTS ----------
        async function analyzeCompanies() {
            if (state.selectedCompanies.length === 0) return;

            const { container, buttonsContainer, metricsSection } = elements;
            container.innerHTML = '';
            buttonsContainer.innerHTML = '';
            state.charts = {};

            metricsSection.style.display = 'block';

            metrics.forEach((metric, index) => {
                // Create iframe
                const iframe = document.createElement('iframe');
                iframe.className = 'chart-frame';
                iframe.id = `chart-${metric}`;
                iframe.src = `/chart/${metric}?theme=${getCurrentTheme()}&companies=${state.selectedCompanies.join(',')}`;
                container.appendChild(iframe);
                state.charts[metric] = iframe;

                // Create button
                const btn = document.createElement('button');
                btn.className = `metric-button ${index === 0 ? 'active' : ''}`;
                btn.textContent = formatMetricName(metric);
                btn.setAttribute('data-metric', metric);
                btn.addEventListener('click', () => showChart(metric));
                buttonsContainer.appendChild(btn);
            });

            if (metrics.length) showChart(metrics[0]);
        }

        function showChart(metric) {
            // Deactivate all
            document.querySelectorAll('.chart-frame').forEach(ifr => ifr.classList.remove('active'));
            document.querySelectorAll('.metric-button').forEach(btn => btn.classList.remove('active'));

            // Activate selected
            const iframe = document.getElementById(`chart-${metric}`);
            if (iframe) iframe.classList.add('active');

            const activeBtn = Array.from(document.querySelectorAll('.metric-button')).find(
                btn => btn.getAttribute('data-metric') === metric
            );
            if (activeBtn) activeBtn.classList.add('active');
        }

        function formatMetricName(metric) {
            const names = {
                'revenue': 'Revenue',
                'net_profit': 'Net Profit',
                'ebitda': 'EBITDA',
                'pe': 'P/E Ratio',
                'roe': 'ROE (%)',
                'capitalization': 'Market Cap',
                'debt': 'Debt'
            };
            return names[metric] || metric;
        }

        function reloadAllIframes(theme) {
            if (state.selectedCompanies.length === 0) return;
            Object.entries(state.charts).forEach(([metric, iframe]) => {
                const wasActive = iframe.classList.contains('active');
                iframe.src = `/chart/${metric}?theme=${theme}&companies=${state.selectedCompanies.join(',')}&t=${Date.now()}`;
                if (wasActive) {
                    iframe.onload = () => iframe.classList.add('active');
                }
            });
        }

        // ---------- DELETE COMPANY (inline confirmation) ----------
        function confirmDeleteCompany(companyName) {
            const overlay = document.createElement('div');
            overlay.className = 'overlay';

            const confirmBox = document.createElement('div');
            confirmBox.className = 'delete-confirmation';
            confirmBox.innerHTML = `
                    <p>Are you sure you want to delete "${companyName}"?</p>
                    <div class="delete-confirmation-buttons">
                        <button class="delete-cancel-btn">Cancel</button>
                        <button class="delete-confirm-btn">Delete</button>
                    </div>
                `;

            document.body.append(overlay, confirmBox);

            const cancelBtn = confirmBox.querySelector('.delete-cancel-btn');
            const deleteBtn = confirmBox.querySelector('.delete-confirm-btn');

            const cleanup = () => {
                overlay.remove();
                confirmBox.remove();
            };

            cancelBtn.addEventListener('click', cleanup);
            overlay.addEventListener('click', cleanup);

            deleteBtn.addEventListener('click', async () => {
                try {
                    const resp = await fetch('/api/companies', {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ company: companyName })
                    });

                    if (!resp.ok) {
                        const errText = await resp.text();
                        throw new Error(errText);
                    }

                    cleanup();
                    await loadData();               // refresh lists
                    deselectAllCompanies();          // clear selection
                    elements.metricsSection.style.display = 'none';
                    alert(`Company "${companyName}" deleted successfully.`);
                } catch (err) {
                    console.error('Delete error:', err);
                    alert(`Error deleting company: ${err.message}`);
                    cleanup();
                }
            });
        }

        // ---------- EVENT LISTENERS ----------
        elements.themeToggle.addEventListener('click', toggleTheme);
        elements.selectAllBtn.addEventListener('click', selectAllCompanies);
        elements.deselectAllBtn.addEventListener('click', deselectAllCompanies);
        elements.analyzeBtn.addEventListener('click', analyzeCompanies);

        // ---------- INITIALIZATION ----------
        loadData();
        loadSavedTheme();
    })();
</script>
</body>
</html>